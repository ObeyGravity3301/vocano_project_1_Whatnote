# 智能专家LLM系统说明

## 概述

智能专家LLM系统是WhatNote的全新功能，它能够自主决定需要什么信息，调用相应的工具函数获取数据，并通过多轮对话为用户提供准确、完整的答案。

## 主要特性

### 🧠 智能决策
- 自动分析用户问题，确定需要哪些信息
- 智能选择合适的工具来获取数据
- 基于获取的真实信息回答，避免臆测

### 🔧 自动工具调用
- **列出文件**：自动获取展板上的所有PDF文件
- **页面内容**：获取PDF特定页面的详细内容
- **文件信息**：获取PDF的基本信息（页数、文件名等）
- **内容搜索**：在PDF中搜索包含特定关键词的页面

### 🔄 多轮对话
- 如果信息不足，会继续获取更多数据
- 最多进行5轮分析和信息收集
- 实时显示当前处理状态

### 📱 用户友好界面
- 实时状态显示，了解AI的工作进度
- 智能模式/普通模式一键切换
- 优雅的加载动画和状态指示

## 使用方法

### 启用智能模式

1. 打开专家LLM对话窗口
2. 点击标题栏的"普通模式"按钮，切换为"智能模式"
3. 现在可以直接提问，无需手动指定需要什么信息

### 示例查询

**查询PDF页面内容：**
```
告诉我4开头那个PDF文件第4页的内容
```

智能系统会：
1. 🔍 分析查询，识别需要找到"4开头"的PDF文件
2. 🔧 调用`list_board_files`工具获取所有文件
3. 🔧 找到匹配的文件后，调用`get_pdf_info`确认页面存在
4. 🔧 调用`get_pdf_page`获取第4页内容
5. ✅ 基于真实数据提供完整答案

**搜索内容：**
```
搜索一下遗传学相关的内容
```

智能系统会：
1. 🔍 分析需要在PDF中搜索遗传学内容
2. 🔧 获取文件列表，识别相关PDF
3. 🔧 使用搜索工具查找包含关键词的页面
4. ✅ 提供搜索结果和相关页面内容

## 技术实现

### 后端架构

**IntelligentExpert类**：
- 管理对话历史和上下文
- 智能解析用户意图
- 执行工具调用和结果处理

**工具函数**：
```python
{
    "get_pdf_page": "获取PDF特定页面内容",
    "get_pdf_info": "获取PDF基本信息",
    "list_board_files": "列出展板文件",
    "search_pdf_content": "搜索PDF内容"
}
```

**WebSocket端点**：
- `/api/expert/intelligent` - 智能专家LLM流式接口
- 支持实时状态推送和结果返回

### 前端实现

**智能模式切换**：
- React状态管理，支持模式切换
- 不同模式使用不同的WebSocket端点

**实时状态显示**：
- 处理状态消息：🔍 🤔 🔧 ✅
- 动态更新消息内容
- 加载动画和视觉反馈

## 状态说明

用户在使用过程中会看到以下状态信息：

| 状态 | 说明 |
|------|------|
| 🔍 开始分析查询 | 开始处理用户问题 |
| 🤔 第N轮分析和信息收集 | 进行第N轮智能分析 |
| 🔧 调用工具：工具名 | 正在使用特定工具获取信息 |
| ✅ 分析完成，生成最终回答 | 完成所有分析，准备返回答案 |
| ⚠️ 达到最大分析轮数 | 已达到5轮上限 |
| ❌ 分析过程出错 | 发生错误 |

## 优势对比

### 传统模式 vs 智能模式

| 方面 | 传统模式 | 智能模式 |
|------|----------|----------|
| **信息获取** | 需手动指定文件和页面 | 自动识别和获取 |
| **错误处理** | 用户需重新尝试 | 自动验证和纠错 |
| **上下文理解** | 基于静态上下文 | 动态获取最新信息 |
| **用户体验** | 需要多次交互 | 一次查询完整答案 |
| **准确性** | 依赖预加载信息 | 基于实时数据 |

## 最佳实践

### 推荐使用场景

1. **探索性查询**：不确定具体文件名或页码时
2. **复杂问题**：需要综合多个文件或页面信息
3. **内容搜索**：查找特定主题或关键词
4. **文件概览**：了解展板上有哪些资源

### 查询技巧

1. **具体描述需求**：
   - ✅ "告诉我关于孟德尔遗传的内容"
   - ❌ "第3页"

2. **提供上下文信息**：
   - ✅ "4开头那个PDF文件第4页的内容"
   - ❌ "第4页内容"

3. **明确查询目标**：
   - ✅ "搜索遗传学相关的章节"
   - ❌ "找一下内容"

## 故障排除

### 常见问题

**Q: 智能模式没有响应？**
A: 检查网络连接，确保后端服务正常运行。可以切换回普通模式测试。

**Q: 提示找不到文件？**
A: 确认展板上已经加载了相关PDF文件，可以先更新展板信息。

**Q: 分析时间过长？**
A: 复杂查询可能需要多轮分析，请耐心等待。系统最多进行5轮分析。

**Q: 工具调用失败？**
A: 检查PDF文件是否可访问，页码是否存在。系统会尝试自动处理常见错误。

## 开发者信息

### API端点
- **WebSocket**: `ws://localhost:8000/api/expert/intelligent`
- **请求格式**: `{"query": "用户问题", "board_id": "展板ID"}`
- **响应格式**: 状态消息 + 最终答案

### 扩展工具

开发者可以通过修改`intelligent_expert.py`中的`_setup_tools`方法来添加新的工具函数：

```python
def _setup_tools(self):
    return {
        "new_tool": {
            "description": "工具描述",
            "parameters": {"param1": "参数说明"},
            "function": self._new_tool_function
        }
    }
```

---

**版本**: 1.0.0  
**更新日期**: 2025-05-24  
**适用于**: WhatNote 智能学习系统 