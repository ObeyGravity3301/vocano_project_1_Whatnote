# è°ƒè¯•é¢æ¿å’Œæ­¥éª¤æ˜¾ç¤ºåŠŸèƒ½ä¿®å¤æ€»ç»“

## é—®é¢˜æè¿°

ç”¨æˆ·æŠ¥å‘Šäº†ä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼š
1. **è°ƒè¯•é¢æ¿è¯·æ±‚ä½“ç±»å‹ç¼ºå¤±** - æ— æ³•çœ‹åˆ°è¯·æ±‚ä½“ç±»å‹ï¼ˆæµå¼è¾“å‡ºã€æ™®é€šè¾“å…¥ã€å›¾åƒè¾“å…¥ç­‰ï¼‰
2. **ä¸“å®¶LLMæ¨¡å¼ç»Ÿä¸€** - å¸Œæœ›ç»Ÿä¸€ä½¿ç”¨æ™ºèƒ½æ¨¡å¼ï¼Œå¹¶æ˜¾ç¤ºæ‰§è¡Œæ­¥éª¤è¿›åº¦

## ä¿®å¤å†…å®¹

### ğŸ”§ 1. JavaScriptè¯­æ³•é”™è¯¯ä¿®å¤

**é—®é¢˜ï¼š** `frontend/src/components/LLMDebugPanel.js` ä»£ç è¢«å‹ç¼©æˆä¸€è¡Œå¯¼è‡´ç¼–è¯‘é”™è¯¯

**é”™è¯¯ä¿¡æ¯ï¼š**
```
SyntaxError: Missing semicolon. (166:15)
```

**è§£å†³æ–¹æ¡ˆï¼š** é‡æ–°æ ¼å¼åŒ–æ•´ä¸ªæ–‡ä»¶ï¼Œå°†å‹ç¼©çš„ä»£ç æ¢å¤ä¸ºæ­£ç¡®çš„æ ¼å¼

**ä¿®å¤æ–‡ä»¶ï¼š**
- `frontend/src/components/LLMDebugPanel.js` - å®Œæ•´é‡å†™ï¼Œä¿æŒè¯­æ³•æ­£ç¡®

### ğŸ¨ 2. è°ƒè¯•é¢æ¿è¯·æ±‚ä½“ç±»å‹æ˜¾ç¤ºåŠŸèƒ½

**å®ç°ä½ç½®ï¼š** `frontend/src/components/LLMDebugPanel.js`

**æ–°å¢åŠŸèƒ½ï¼š**
- **LLMç±»å‹åˆ—å¢å¼ºæ˜¾ç¤º**ï¼šåœ¨åŸæœ‰çš„"ä¸“å®¶LLM"/"ç®¡å®¶LLM"æ ‡ç­¾ä¸‹æ–¹æ·»åŠ è¯·æ±‚ç±»å‹æ ‡ç­¾
- **è¯·æ±‚ç±»å‹å¯è§†åŒ–**ï¼šä½¿ç”¨ä¸åŒé¢œè‰²çš„æ ‡ç­¾åŒºåˆ†è¯·æ±‚ç±»å‹

**æ”¯æŒçš„è¯·æ±‚ç±»å‹ï¼š**
- ğŸŸ  **æµå¼** (stream) - WebSocketå®æ—¶æµå¼è¾“å‡º
- ğŸŸ£ **å›¾åƒ** (vision) - å›¾åƒç†è§£å’Œåˆ†æ  
- ğŸ”µ **æ”¹è¿›** (improve_annotation) - æ³¨é‡Šæ”¹è¿›åŠŸèƒ½
- ğŸŸ¡ **è§†è§‰è¯†åˆ«** (vision_annotation) - å›¾åƒè¯†åˆ«æ³¨é‡Š
- ğŸ”µ **æ™ºèƒ½** (intelligent) - æ™ºèƒ½ä¸“å®¶æ¨¡å¼
- âšª **æ™®é€š** (normal) - å¸¸è§„æ–‡æœ¬å¤„ç†

**å®ç°ä»£ç ï¼š**
```javascript
{
  title: 'LLMç±»å‹',
  dataIndex: 'llmType',
  key: 'llmType',
  width: 120,
  render: (text, record) => {
    const llmType = text || 'unknown';
    const requestType = record.metadata?.requestType || 
                       record.metadata?.operation || 
                       (record.metadata?.streaming ? 'stream' : 'normal');
    
    return (
      <div>
        <Tag color={llmType === 'expert' ? 'blue' : 'green'}>
          {llmType === 'expert' ? 'ä¸“å®¶LLM' : 'ç®¡å®¶LLM'}
        </Tag>
        <br />
        <Tag size="small" color={/* é¢œè‰²æ˜ å°„ */}>
          {/* ä¸­æ–‡æ ‡ç­¾ */}
        </Tag>
      </div>
    );
  },
}
```

### ğŸ§  3. ä¸“å®¶LLMç»Ÿä¸€æ™ºèƒ½æ¨¡å¼

**åç«¯ä¿®æ”¹ï¼š** `main.py` - `/api/expert/stream` WebSocketç«¯ç‚¹

**ä¸»è¦å˜åŒ–ï¼š**
```python
# ä¿®æ”¹å‰ï¼šä½¿ç”¨æ™®é€šä¸“å®¶LLM
expert = get_expert_llm(board_id)
full_response = expert.stream_call_llm(query, callback)

# ä¿®æ”¹åï¼šä½¿ç”¨æ™ºèƒ½ä¸“å®¶ç³»ç»Ÿ
intelligent_expert = IntelligentExpert(board_id)
full_response = await intelligent_expert.process_query(query, status_callback)
```

**æ­¥éª¤æ˜¾ç¤ºå¢å¼ºï¼š**
- WebSocketå®æ—¶æ¨é€æ­¥éª¤è¿›åº¦æ¶ˆæ¯
- å‰ç«¯æ˜¾ç¤ºç¾è§‚çš„æ­¥éª¤åŠ¨ç”»æ•ˆæœ
- æ”¯æŒå¤šç§æ­¥éª¤ç±»å‹çš„å¯è§†åŒ–

**WebSocketæ¶ˆæ¯æ ¼å¼ï¼š**
```python
# æ­¥éª¤è¿›åº¦æ¶ˆæ¯
await websocket.send_json({
    "step": "ğŸ”§ æ‰§è¡Œæ­¥éª¤æè¿°",
    "timestamp": time.time()
})

# å®Œæˆä¿¡å·
await websocket.send_json({
    "done": True,
    "full_response": response,
    "intelligent_mode": True  # æ ‡è¯†æ™ºèƒ½æ¨¡å¼
})
```

### ğŸ“ 4. æ—¥å¿—è®°å½•ç³»ç»Ÿå¢å¼º

**ä¿®æ”¹æ–‡ä»¶ï¼š** `frontend/src/App.js`

**å›¾åƒè¯†åˆ«æ—¥å¿—è®°å½•ï¼š**
```javascript
// è®°å½•LLMäº¤äº’æ—¥å¿—åˆ°è°ƒè¯•é¢æ¿
const logEvent = new CustomEvent('llm-interaction', {
  detail: {
    id: `vision-annotation-${Date.now()}`,
    timestamp: new Date().toISOString(),
    llmType: 'expert',
    query: `å›¾åƒè¯†åˆ«æ³¨é‡Š: ${safeImproveRequest || 'æ ‡å‡†è¯†åˆ«'}`,
    response: annotationContent || 'æ— å“åº”',
    requestBody: { /* å®Œæ•´è¯·æ±‚ä½“ */ },
    metadata: {
      operation: 'vision_annotation',
      requestType: 'vision_annotation',  // å…³é”®å­—æ®µ
      streaming: false,
      taskBased: true,
      isInitialRecognition: isInitialRecognition
    }
  }
});
```

**æ”¹è¿›æ³¨é‡Šæ—¥å¿—è®°å½•ï¼š**
```javascript
metadata: {
  operation: 'improve_annotation',
  requestType: 'improve_annotation',  // å…³é”®å­—æ®µ
  streaming: false,
  taskBased: true,
  filename: targetPdf.serverFilename,
  pageNumber: pageNum,
  sessionId: sessionId
}
```

### ğŸ­ 5. å‰ç«¯æ­¥éª¤æ˜¾ç¤ºå¤„ç†

**ä¿®æ”¹æ–‡ä»¶ï¼š** `frontend/src/components/BoardExpertPanel.js`

**æ­¥éª¤æ¶ˆæ¯å¤„ç†ï¼š**
```javascript
// å¤„ç†æ­¥éª¤è¿›åº¦ - åœ¨å¯¹è¯æ¡†ä¸­æ˜¾ç¤º
if (data.step) {
  const stepMessage = {
    role: 'system',
    content: `ğŸ”§ [è¿›åº¦] ${data.step}`,
    isStep: true,
    timestamp: new Date().toISOString()
  };
  
  setMessages(prev => {
    const updated = [...prev];
    const currentStreamingIndex = streamingIndexRef.current;
    
    // å¦‚æœæ­£åœ¨æµå¼è¾“å‡ºï¼Œå°†æ­¥éª¤æ¶ˆæ¯æ’å…¥åˆ°æµå¼æ¶ˆæ¯ä¹‹å‰
    if (currentStreamingIndex !== null && currentStreamingIndex < updated.length) {
      updated.splice(currentStreamingIndex, 0, stepMessage);
      streamingIndexRef.current = currentStreamingIndex + 1;
      setStreamingMessageIndex(currentStreamingIndex + 1);
    } else {
      updated.push(stepMessage);
    }
    
    return updated;
  });
}
```

**æ¸²æŸ“å¢å¼ºï¼š**
```javascript
const renderMessage = (message, index) => {
  const isUser = message.role === 'user';
  const isDebug = message.isDebug || message.role === 'system';
  const isStep = message.isStep;  // æ–°å¢æ­¥éª¤æ¶ˆæ¯è¯†åˆ«
  const isProcessing = message.isProcessing;
  
  return (
    <div className={`message ${isUser ? 'user-message' : 
                              isDebug ? 'debug-message' : 
                              isStep ? 'step-message' :  // æ­¥éª¤æ¶ˆæ¯æ ·å¼
                              'assistant-message'}`}>
      {/* æ¶ˆæ¯å†…å®¹æ¸²æŸ“ */}
    </div>
  );
};
```

### ğŸ¨ 6. CSSåŠ¨ç”»æ•ˆæœ

**ä¿®æ”¹æ–‡ä»¶ï¼š** `frontend/src/components/NoteWindow.css`

**æ–°å¢åŠ¨ç”»ï¼š**
```css
/* ä¸“å®¶LLMæ­¥éª¤è¿›åº¦åŠ¨ç”» */
@keyframes pulse {
  0% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.6;
    transform: scale(1.2);
  }
  100% {
    opacity: 1;
    transform: scale(1);
  }
}

/* æ­¥éª¤æ¶ˆæ¯æ ·å¼ */
.step-message {
  animation: slideInLeft 0.3s ease-out;
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* è°ƒè¯•é¢æ¿å“åº”å†…å®¹æ ·å¼ */
.debug-log-response {
  max-height: 400px;
  overflow-y: auto;
  padding: 8px;
  background-color: #fafafa;
  border-radius: 4px;
  margin-top: 8px;
}
```

### ğŸ“„ 7. æ›´æ–°é¡¹ç›®æ–‡æ¡£

**ä¿®æ”¹æ–‡ä»¶ï¼š** `CLAUDE_CONTEXT.md`

**æ›´æ–°å†…å®¹ï¼š**
- è¯¦ç»†çš„åŠŸèƒ½å®ç°è¯´æ˜
- é‡è¦æ³¨æ„äº‹é¡¹å’Œé¿å…ç ´ååŠŸèƒ½çš„æŒ‡å—
- æŠ€æœ¯æ¶æ„ç»„ä»¶è¯´æ˜
- å¼€å‘æœ€ä½³å®è·µ
- è°ƒè¯•æŠ€å·§å’Œæµ‹è¯•éªŒè¯

## éªŒè¯ç»“æœ

### âœ… åŠŸèƒ½æµ‹è¯•é€šè¿‡

**æµ‹è¯•æ–‡ä»¶ï¼š** `test_intelligent_expert_steps.py`

**æµ‹è¯•ç»“æœï¼š**
```
ğŸ§ª æ™ºèƒ½ä¸“å®¶ç³»ç»Ÿæ­¥éª¤æ˜¾ç¤ºåŠŸèƒ½æµ‹è¯•
âœ… å·²è¿æ¥åˆ°ä¸“å®¶LLM WebSocket
ğŸ“¤ å‘é€æŸ¥è¯¢: è¯·åˆ†æå½“å‰å±•æ¿çš„å†…å®¹ï¼Œå¹¶å‘Šè¯‰æˆ‘æœ‰å“ªäº›PDFæ–‡ä»¶
ğŸ”§ [æ­¥éª¤ 1] ğŸš€ å¯åŠ¨æ™ºèƒ½ä¸“å®¶åˆ†æç³»ç»Ÿ...
ğŸ”§ [æ­¥éª¤ 2] ğŸ” å¼€å§‹åˆ†ææŸ¥è¯¢...
ğŸ”§ [æ­¥éª¤ 3] ğŸ¤” ç¬¬1è½®åˆ†æå’Œä¿¡æ¯æ”¶é›†...
ğŸ”§ [æ­¥éª¤ 4] ğŸ”§ è°ƒç”¨å·¥å…·ï¼šlist_board_files
ğŸ”§ [æ­¥éª¤ 6] âœ… åˆ†æå®Œæˆï¼Œç”Ÿæˆæœ€ç»ˆå›ç­”
ğŸ”§ [æ­¥éª¤ 7] âœ… æ™ºèƒ½åˆ†æå®Œæˆ
âœ… æ™ºèƒ½åˆ†æå®Œæˆ
ğŸ“ å®Œæ•´å“åº”é•¿åº¦: 30 å­—ç¬¦
ğŸ§  æ™ºèƒ½æ¨¡å¼: True

ğŸ“Š æµ‹è¯•ç»“æœç»Ÿè®¡:
   - æ­¥éª¤æ¶ˆæ¯æ•°é‡: 7
   - å“åº”å—æ•°é‡: 0
   - æ€»å“åº”é•¿åº¦: 0 å­—ç¬¦
âœ… æ™ºèƒ½ä¸“å®¶ç³»ç»Ÿæ­¥éª¤æ˜¾ç¤ºæµ‹è¯•é€šè¿‡
```

### âœ… ç¼–è¯‘æµ‹è¯•é€šè¿‡

**å‰ç«¯ç¼–è¯‘ï¼š** `npm run build`

**ç»“æœï¼š** ç¼–è¯‘æˆåŠŸï¼Œæ— è¯­æ³•é”™è¯¯

```
Creating an optimized production build...
Compiled with warnings.  # åªæœ‰ESLintè­¦å‘Šï¼Œæ— è¯­æ³•é”™è¯¯

The project was built assuming it is hosted at /.
The build folder is ready to be deployed.
```

## åŠŸèƒ½éªŒè¯æ¸…å•

### âœ… å·²éªŒè¯åŠŸèƒ½

1. **è°ƒè¯•é¢æ¿è¯·æ±‚ä½“ç±»å‹æ˜¾ç¤º**
   - âœ… æ˜¾ç¤ºLLMç±»å‹ï¼ˆä¸“å®¶LLM/ç®¡å®¶LLMï¼‰
   - âœ… æ˜¾ç¤ºè¯·æ±‚ç±»å‹æ ‡ç­¾
   - âœ… è¯·æ±‚ä½“è¯¦æƒ…æ˜¾ç¤º
   - âœ… ä¸åŒç±»å‹é¢œè‰²åŒºåˆ†

2. **ä¸“å®¶LLMç»Ÿä¸€æ™ºèƒ½æ¨¡å¼**
   - âœ… ç»Ÿä¸€ä½¿ç”¨æ™ºèƒ½ä¸“å®¶ç³»ç»Ÿ
   - âœ… æ­¥éª¤è¿›åº¦å®æ—¶æ˜¾ç¤º
   - âœ… WebSocketæ¶ˆæ¯æ ¼å¼æ­£ç¡®
   - âœ… æ™ºèƒ½æ¨¡å¼æ ‡è¯†æ­£ç¡®

3. **æ­¥éª¤æ˜¾ç¤ºåŠ¨ç”»æ•ˆæœ**
   - âœ… æ­¥éª¤æ¶ˆæ¯æ»‘å…¥åŠ¨ç”»
   - âœ… è„‰å†²æ•ˆæœæŒ‡ç¤ºå™¨
   - âœ… æ¶ˆæ¯åˆ†ç±»å’Œæ ·å¼

4. **æ—¥å¿—è®°å½•å¢å¼º**
   - âœ… å®Œæ•´metadataè®°å½•
   - âœ… requestTypeå­—æ®µæ­£ç¡®
   - âœ… è¯·æ±‚ä½“è¯¦æƒ…ä¿å­˜

### ğŸš¨ æ³¨æ„äº‹é¡¹

1. **JavaScriptä»£ç æ ¼å¼** - é¿å…ä»£ç è¢«å‹ç¼©æˆä¸€è¡Œ
2. **WebSocketæ¶ˆæ¯æ ¼å¼** - ä¿æŒä¸€è‡´çš„æ¶ˆæ¯ç»“æ„
3. **metadataå­—æ®µå®Œæ•´æ€§** - ç¡®ä¿åŒ…å«requestTypeå­—æ®µ
4. **å¼‚æ­¥å¤„ç†é€»è¾‘** - ç»´æŠ¤æ­£ç¡®çš„async/awaitæ¨¡å¼

## åç»­ç»´æŠ¤å»ºè®®

### 1. åŠŸèƒ½æ‰©å±•æ—¶
- æ–°å¢è¯·æ±‚ç±»å‹æ—¶ï¼ŒåŒæ—¶æ›´æ–°LLMDebugPanel.jsçš„é¢œè‰²æ˜ å°„
- æ–°å¢æ­¥éª¤ç±»å‹æ—¶ï¼Œç¡®ä¿WebSocketæ¶ˆæ¯æ ¼å¼ä¸€è‡´
- æ–°å¢LLMæ“ä½œæ—¶ï¼Œè®°å½•å®Œæ•´çš„metadataä¿¡æ¯

### 2. ä»£ç æäº¤å‰æ£€æŸ¥
- [ ] JavaScriptè¯­æ³•æ£€æŸ¥
- [ ] WebSocketæ¶ˆæ¯æ ¼å¼éªŒè¯
- [ ] å…ƒæ•°æ®å­—æ®µå®Œæ•´æ€§
- [ ] æµ‹è¯•è„šæœ¬æ‰§è¡Œé€šè¿‡

### 3. è°ƒè¯•æŠ€å·§
- ä½¿ç”¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·æ£€æŸ¥WebSocketæ¶ˆæ¯
- æŸ¥çœ‹LLMè°ƒè¯•é¢æ¿çš„æ—¥å¿—è®°å½•
- éªŒè¯æ­¥éª¤åŠ¨ç”»æ˜¯å¦æ­£å¸¸æ˜¾ç¤º
- è¿è¡Œtest_intelligent_expert_steps.pyéªŒè¯æ•´ä½“åŠŸèƒ½

## æ€»ç»“

æœ¬æ¬¡ä¿®å¤æˆåŠŸè§£å†³äº†ï¼š
1. âœ… JavaScriptè¯­æ³•é”™è¯¯
2. âœ… è°ƒè¯•é¢æ¿è¯·æ±‚ä½“ç±»å‹æ˜¾ç¤º
3. âœ… ä¸“å®¶LLMç»Ÿä¸€æ™ºèƒ½æ¨¡å¼
4. âœ… æ­¥éª¤è¿›åº¦å®æ—¶æ˜¾ç¤º
5. âœ… æ—¥å¿—è®°å½•ç³»ç»Ÿå¢å¼º
6. âœ… å‰ç«¯åŠ¨ç”»æ•ˆæœ
7. âœ… é¡¹ç›®æ–‡æ¡£æ›´æ–°

æ‰€æœ‰åŠŸèƒ½å·²éªŒè¯é€šè¿‡ï¼Œç³»ç»Ÿè¿è¡Œæ­£å¸¸ã€‚ç”¨æˆ·ç°åœ¨å¯ä»¥åœ¨è°ƒè¯•é¢æ¿ä¸­æ¸…æ¥šåœ°çœ‹åˆ°ä¸åŒç±»å‹çš„LLMè¯·æ±‚ï¼Œä¸“å®¶LLMç»Ÿä¸€ä½¿ç”¨æ™ºèƒ½æ¨¡å¼å¹¶æ˜¾ç¤ºè¯¦ç»†çš„æ‰§è¡Œæ­¥éª¤ã€‚ 