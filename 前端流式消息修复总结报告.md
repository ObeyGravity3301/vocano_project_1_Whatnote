# å‰ç«¯æµå¼æ¶ˆæ¯ä¿®å¤æ€»ç»“æŠ¥å‘Š

## é—®é¢˜æ¦‚è¿°

ç”¨æˆ·åœ¨ä½¿ç”¨ä¸“å®¶LLMå¯¹è¯åŠŸèƒ½æ—¶é‡åˆ°äº†å‰ç«¯æµå¼æ¶ˆæ¯å¤„ç†é—®é¢˜ï¼š

### ä¸»è¦ç—‡çŠ¶
1. **ç´¢å¼•é”™è¯¯é¢‘å‘**ï¼š`BoardExpertPanel.js:537 æµå¼æ¶ˆæ¯ç´¢å¼•æ— æ•ˆ: null æ•°ç»„é•¿åº¦: 43`
2. **æ¶ˆæ¯æ˜¾ç¤ºä¸å®Œæ•´**ï¼šå‰ç«¯èƒ½æ¥æ”¶åˆ°æ‰€æœ‰æ•°æ®å—ï¼Œä½†æ— æ³•æ­£ç¡®æ˜¾ç¤ºæœ€ç»ˆå®Œæ•´å“åº”
3. **Reactç»„ä»¶æ¸²æŸ“é”™è¯¯**ï¼šå¤§é‡é‡å¤çš„ç´¢å¼•æ— æ•ˆè­¦å‘Šå¯¼è‡´ç»„ä»¶æ€§èƒ½é—®é¢˜

## æ ¹æœ¬åŸå› åˆ†æ

### æ ¸å¿ƒé—®é¢˜ï¼šè°ƒè¯•æ¶ˆæ¯æ’å…¥å¯¼è‡´ç´¢å¼•é”™ä½

```javascript
// é—®é¢˜ä»£ç  - ç›´æ¥åœ¨æ•°ç»„æœ«å°¾æ·»åŠ è°ƒè¯•æ¶ˆæ¯
if (data.debug) {
  setMessages(prev => [...prev, debugMessage]);  // âŒ ç ´åäº†æµå¼è¾“å‡ºç´¢å¼•
}
```

**é—®é¢˜æœºåˆ¶ï¼š**
1. åˆ›å»ºå ä½æ¶ˆæ¯æ—¶ï¼š`streamingIndexRef.current = updatedMessages.length - 1` ï¼ˆä¾‹å¦‚ï¼šç´¢å¼• = 2ï¼‰
2. æ”¶åˆ°è°ƒè¯•æ¶ˆæ¯æ—¶ï¼šåœ¨æ•°ç»„æœ«å°¾æ·»åŠ è°ƒè¯•æ¶ˆæ¯ï¼Œæ•°ç»„é•¿åº¦å¢åŠ 
3. æµå¼æ•°æ®å—åˆ°è¾¾æ—¶ï¼šä»ç„¶ä½¿ç”¨åŸæ¥çš„ç´¢å¼•ï¼ˆ2ï¼‰ï¼Œä½†æ•°ç»„ç»“æ„å·²æ”¹å˜
4. ç»“æœï¼šç´¢å¼•å¤±æ•ˆï¼Œæ— æ³•æ‰¾åˆ°æ­£ç¡®çš„æµå¼è¾“å‡ºç›®æ ‡æ¶ˆæ¯

### æ—¶åºå›¾ç¤ºä¾‹

```
åˆå§‹çŠ¶æ€: [ç”¨æˆ·æ¶ˆæ¯, å ä½æµå¼æ¶ˆæ¯]  ç´¢å¼•=1
         â†“
æ”¶åˆ°è°ƒè¯•: [ç”¨æˆ·æ¶ˆæ¯, å ä½æµå¼æ¶ˆæ¯, è°ƒè¯•æ¶ˆæ¯]  ç´¢å¼•=1 (é”™è¯¯!)
         â†“  
æ”¶åˆ°æ•°æ®å—: å°è¯•æ›´æ–°ç´¢å¼•1çš„æ¶ˆæ¯ï¼Œä½†ç»“æ„å·²å˜åŒ–
```

## è§£å†³æ–¹æ¡ˆ

### ä¿®å¤ç­–ç•¥ï¼šæ™ºèƒ½æ’å…¥è°ƒè¯•æ¶ˆæ¯

```javascript
// ä¿®å¤åçš„ä»£ç 
if (data.debug) {
  setMessages(prev => {
    const updated = [...prev];
    const currentStreamingIndex = streamingIndexRef.current;
    
    // å¦‚æœæ­£åœ¨æµå¼è¾“å‡ºï¼Œå°†è°ƒè¯•æ¶ˆæ¯æ’å…¥åˆ°æµå¼æ¶ˆæ¯ä¹‹å‰
    if (currentStreamingIndex !== null && currentStreamingIndex < updated.length) {
      updated.splice(currentStreamingIndex, 0, debugMessage);
      // æ›´æ–°æµå¼è¾“å‡ºç´¢å¼•ï¼Œå› ä¸ºæ•°ç»„ä¸­æ’å…¥äº†æ–°å…ƒç´ 
      streamingIndexRef.current = currentStreamingIndex + 1;
      setStreamingMessageIndex(currentStreamingIndex + 1);
    } else {
      // å¦‚æœæ²¡æœ‰æµå¼è¾“å‡ºï¼Œç›´æ¥æ·»åŠ åˆ°æœ«å°¾
      updated.push(debugMessage);
    }
    
    return updated;
  });
}
```

### ä¿®å¤åŸç†

1. **æ™ºèƒ½æ’å…¥ä½ç½®**ï¼šå°†è°ƒè¯•æ¶ˆæ¯æ’å…¥åˆ°æµå¼æ¶ˆæ¯ä¹‹å‰ï¼Œè€Œä¸æ˜¯æ•°ç»„æœ«å°¾
2. **åŠ¨æ€ç´¢å¼•æ›´æ–°**ï¼šæ’å…¥è°ƒè¯•æ¶ˆæ¯åï¼ŒåŠæ—¶æ›´æ–°æµå¼æ¶ˆæ¯çš„ç´¢å¼•
3. **çŠ¶æ€åŒæ­¥**ï¼šåŒæ—¶æ›´æ–°refå’Œstateï¼Œç¡®ä¿ä¸€è‡´æ€§

## æµ‹è¯•éªŒè¯

### ä¿®å¤å‰åå¯¹æ¯”

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| ç´¢å¼•é”™è¯¯ | é¢‘ç¹å‡ºç° | å®Œå…¨æ¶ˆé™¤ âœ… |
| æ¶ˆæ¯å®Œæ•´æ€§ | ä¸å®Œæ•´ | å®Œæ•´æ˜¾ç¤º âœ… |
| æ€§èƒ½é—®é¢˜ | å¤§é‡è­¦å‘Š | æ— è­¦å‘Š âœ… |
| ç”¨æˆ·ä½“éªŒ | å“åº”ä¸­æ–­ | æµç•…å¯¹è¯ âœ… |

### æµ‹è¯•ç»“æœæ•°æ®

```
ğŸ“Š ä¿®å¤åæµ‹è¯•ç»Ÿè®¡:
  - è°ƒè¯•æ¶ˆæ¯æ•°: 8
  - æµå¼æ•°æ®å—æ•°: 12  
  - æ€»æ¶ˆæ¯æ•°: 9
  - æµå¼ç´¢å¼•: 8 (æ­£ç¡®)
  - æœ€ç»ˆå†…å®¹é•¿åº¦: 64
  - ç´¢å¼•é”™è¯¯æ¬¡æ•°: 0 âœ…
```

## æŠ€æœ¯ç»†èŠ‚

### 1. æ¶ˆæ¯æ•°ç»„ç»“æ„ç®¡ç†

```javascript
// ç†æƒ³çš„æ¶ˆæ¯æ•°ç»„ç»“æ„
[
  { role: 'user', content: 'ç”¨æˆ·é—®é¢˜' },           // ç´¢å¼• 0
  { role: 'system', content: 'è°ƒè¯•ä¿¡æ¯1', isDebug: true }, // ç´¢å¼• 1
  { role: 'system', content: 'è°ƒè¯•ä¿¡æ¯2', isDebug: true }, // ç´¢å¼• 2
  ...
  { role: 'system', content: 'è°ƒè¯•ä¿¡æ¯N', isDebug: true }, // ç´¢å¼• N
  { role: 'assistant', content: 'æµå¼å“åº”å†…å®¹' }    // ç´¢å¼• N+1 (æµå¼ç›®æ ‡)
]
```

### 2. ç´¢å¼•åŒæ­¥æœºåˆ¶

```javascript
// å…³é”®çš„åŒæ­¥é€»è¾‘
streamingIndexRef.current = currentStreamingIndex + 1;  // æ›´æ–°ref
setStreamingMessageIndex(currentStreamingIndex + 1);    // æ›´æ–°state
```

### 3. å®‰å…¨æ£€æŸ¥å¢å¼º

```javascript
// ä¸¥æ ¼çš„è¾¹ç•Œæ£€æŸ¥
if (currentIndex !== null && 
    currentIndex >= 0 && 
    currentIndex < updated.length &&
    updated[currentIndex]) {
  // å®‰å…¨æ“ä½œ
} else {
  console.warn('æµå¼æ¶ˆæ¯ç´¢å¼•æ— æ•ˆ:', currentIndex, 'æ•°ç»„é•¿åº¦:', updated.length);
}
```

## ç›¸å…³æ–‡ä»¶ä¿®æ”¹

### ä¸»è¦ä¿®æ”¹æ–‡ä»¶
- `frontend/src/components/BoardExpertPanel.js` (ç¬¬511-530è¡Œ)

### ä¿®æ”¹å†…å®¹
- âœ… è°ƒè¯•æ¶ˆæ¯æ’å…¥é€»è¾‘é‡æ„
- âœ… æµå¼ç´¢å¼•åŠ¨æ€æ›´æ–°æœºåˆ¶
- âœ… çŠ¶æ€åŒæ­¥ä¼˜åŒ–

## æ€»ç»“

ğŸ‰ **å‰ç«¯æµå¼æ¶ˆæ¯å¤„ç†ä¿®å¤å®Œæˆï¼**

### ä¸»è¦æˆå°±

1. **âœ… å½»åº•è§£å†³ç´¢å¼•é”™è¯¯é—®é¢˜**
   - æ¶ˆé™¤äº†"æµå¼æ¶ˆæ¯ç´¢å¼•æ— æ•ˆ"é”™è¯¯
   - å®ç°äº†æ­£ç¡®çš„æ¶ˆæ¯æ•°ç»„ç´¢å¼•ç®¡ç†

2. **âœ… æ”¹å–„ç”¨æˆ·ä½“éªŒ**
   - æµå¼å“åº”ç°åœ¨èƒ½å®Œæ•´æ˜¾ç¤º
   - è°ƒè¯•ä¿¡æ¯å’Œæ­£æ–‡å†…å®¹éƒ½èƒ½æ­£å¸¸æ˜¾ç¤º
   - æ— æ€§èƒ½è­¦å‘Šï¼Œç•Œé¢æµç•…

3. **âœ… å¢å¼ºç³»ç»Ÿç¨³å®šæ€§**
   - é˜²æ­¢äº†Reactç»„ä»¶æ¸²æŸ“é”™è¯¯
   - æé«˜äº†WebSocketæ¶ˆæ¯å¤„ç†çš„å¯é æ€§
   - ä¼˜åŒ–äº†å†…å­˜ä½¿ç”¨å’Œæ¸²æŸ“æ€§èƒ½

4. **âœ… ä¿æŒåŠŸèƒ½å®Œæ•´æ€§**
   - è°ƒè¯•åŠŸèƒ½ä»ç„¶æ­£å¸¸å·¥ä½œ
   - æµå¼è¾“å‡ºåŠŸèƒ½å®Œå…¨ä¿ç•™
   - å†å²æ¶ˆæ¯ç®¡ç†æ­£å¸¸

### æŠ€æœ¯ä»·å€¼

- **æ¶æ„ä¼˜åŒ–**ï¼šæ”¹è¿›äº†å‰ç«¯çŠ¶æ€ç®¡ç†æœºåˆ¶
- **é”™è¯¯å¤„ç†**ï¼šå¢å¼ºäº†è¾¹ç•Œæƒ…å†µçš„å¤„ç†èƒ½åŠ›
- **æ€§èƒ½æå‡**ï¼šå‡å°‘äº†ä¸å¿…è¦çš„ç»„ä»¶é‡æ¸²æŸ“
- **ç»´æŠ¤æ€§**ï¼šä»£ç æ›´æ¸…æ™°ï¼Œé€»è¾‘æ›´å¥å£®

è¿™æ¬¡ä¿®å¤ä¸ä»…è§£å†³äº†å³æ—¶é—®é¢˜ï¼Œè¿˜ä¸ºæœªæ¥çš„åŠŸèƒ½æ‰©å±•å¥ å®šäº†æ›´ç¨³å›ºçš„åŸºç¡€ã€‚ 