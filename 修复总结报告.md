# ğŸ‰ ä¸“å®¶LLMæµå¼å¤„ç†ä¿®å¤æ€»ç»“æŠ¥å‘Š

## é—®é¢˜æè¿°
ç”¨æˆ·åœ¨ä½¿ç”¨ä¸“å®¶LLM WebSocketæµå¼å¤„ç†æ—¶é‡åˆ°é”™è¯¯ï¼š
```
'ExpertLLM' object has no attribute '_prepare_messages'
```

## é—®é¢˜åŸå› åˆ†æ
1. **ç¼ºå¤±æ–¹æ³•**: `expert_llm.py`ä¸­çš„`stream_call_llm`æ–¹æ³•è°ƒç”¨äº†ä¸å­˜åœ¨çš„`_prepare_messages`æ–¹æ³•
2. **ä¸Šä¸‹æ–‡é›†æˆé—®é¢˜**: è™½ç„¶ä¹‹å‰ä¿®å¤äº†BoardManageré›†æˆï¼Œä½†æµå¼å¤„ç†ä¸­çš„æ–¹æ³•ç¼ºå¤±å¯¼è‡´WebSocketè¿æ¥å¤±è´¥
3. **æµå¼APIå®ç°é—®é¢˜**: OpenAIå®¢æˆ·ç«¯çš„æµå¼å¤„ç†åœ¨æŸäº›ç¯å¢ƒä¸‹å¯èƒ½ä¸ç¨³å®š

## ä¿®å¤è¿‡ç¨‹

### 1. æ·»åŠ ç¼ºå¤±çš„`_prepare_messages`æ–¹æ³•
```python
def _prepare_messages(self, prompt):
    """
    å‡†å¤‡å‘é€ç»™LLMçš„æ¶ˆæ¯åˆ—è¡¨
    
    Args:
        prompt: ç”¨æˆ·æç¤ºè¯
        
    Returns:
        æ ¼å¼åŒ–çš„æ¶ˆæ¯åˆ—è¡¨
    """
    # è·å–å†å²å¯¹è¯
    conversation_history = conversation_manager.get_conversation(self.session_id, self.board_id)
    
    # æ·»åŠ å½“å‰ç”¨æˆ·æ¶ˆæ¯åˆ°å†å²è®°å½•
    conversation_manager.add_message(
        self.session_id, 
        self.board_id, 
        "user", 
        prompt
    )
    
    # æ„å»ºæ­£ç¡®æ ¼å¼çš„æ¶ˆæ¯åˆ—è¡¨
    messages = []
    
    # æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
    system_msg = next((msg for msg in conversation_history if msg.get("role") == "system"), None)
    if system_msg:
        messages.append({"role": "system", "content": system_msg.get("content", "")})
    
    # æ·»åŠ æœ€è¿‘çš„å¯¹è¯å†å²
    for msg in conversation_history[-8:]:  # æœ€å¤šå–æœ€è¿‘8æ¡å†å²è®°å½•
        role = msg.get("role")
        content = msg.get("content")
        
        if role and content and role in ["user", "assistant"]:
            messages.append({"role": role, "content": content})
    
    # ç¡®ä¿æœ€åä¸€æ¡æ˜¯å½“å‰ç”¨æˆ·æ¶ˆæ¯
    if not (len(messages) >= 2 and messages[-1]["role"] == "user" and messages[-1]["content"] == prompt):
        messages.append({"role": "user", "content": prompt})
    
    return messages
```

### 2. ä¼˜åŒ–æµå¼å¤„ç†å®ç°
- å°†OpenAIå®¢æˆ·ç«¯æ”¹ä¸ºç›´æ¥ä½¿ç”¨requests
- ä½¿ç”¨SSE (Server-Sent Events) æ ¼å¼è§£ææµå¼å“åº”
- æ”¹è¿›é”™è¯¯å¤„ç†å’Œå›è°ƒæœºåˆ¶

```python
# ä½¿ç”¨requestsç›´æ¥è°ƒç”¨æµå¼API
url = "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions"
headers = {
    "Authorization": f"Bearer {QWEN_API_KEY}",
    "Content-Type": "application/json"
}

data = {
    "model": "qwen-plus",
    "messages": messages,
    "stream": True,
    "temperature": 0.7
}

# ä½¿ç”¨æµå¼è¯·æ±‚
with requests.post(url, headers=headers, json=data, stream=True, timeout=60) as response:
    response.raise_for_status()
    
    for line in response.iter_lines():
        if line:
            line = line.decode('utf-8')
            if line.startswith('data: '):
                data_str = line[6:]  # å»æ‰ 'data: ' å‰ç¼€
                
                if data_str.strip() == '[DONE]':
                    break
                    
                try:
                    chunk_data = json.loads(data_str)
                    if 'choices' in chunk_data and chunk_data['choices']:
                        delta = chunk_data['choices'][0].get('delta', {})
                        content = delta.get('content', '')
                        
                        if content:
                            full_response += content
                            
                            # å¦‚æœæœ‰å›è°ƒå‡½æ•°ï¼Œåˆ™è°ƒç”¨
                            if callback and callable(callback):
                                try:
                                    callback(content)
                                except Exception as callback_error:
                                    logger.warning(f"å›è°ƒå‡½æ•°æ‰§è¡Œå¤±è´¥: {callback_error}")
                                    
                except json.JSONDecodeError:
                    continue
```

## æµ‹è¯•éªŒè¯

### æµ‹è¯•1: æ–¹æ³•å­˜åœ¨æ€§éªŒè¯ âœ…
```
âœ… _prepare_messagesæ–¹æ³•å­˜åœ¨
âœ… _prepare_messagesæ–¹æ³•å¯è°ƒç”¨
```

### æµ‹è¯•2: å±•æ¿ä¸Šä¸‹æ–‡é›†æˆéªŒè¯ âœ…
```
âœ… å±•æ¿ä¸Šä¸‹æ–‡æ›´æ–°æˆåŠŸ
âœ… ä¸“å®¶LLMå®ä¾‹åˆ›å»ºæˆåŠŸ
âœ… _prepare_messagesæ–¹æ³•æ­£å¸¸å·¥ä½œ
âœ… æ¶ˆæ¯æ•°é‡: 3
âœ… ç®€å•è°ƒç”¨æˆåŠŸï¼Œå“åº”é•¿åº¦: 163
```

### æµ‹è¯•3: æµå¼å¤„ç†éªŒè¯ âœ…
```
âœ… æµå¼è°ƒç”¨æˆåŠŸ
âœ… å—æ•°é‡: 18
âœ… å®Œæ•´å“åº”é•¿åº¦: 120
```

### æµ‹è¯•4: å®é™…åŠŸèƒ½æµ‹è¯• âœ…
```
ğŸ“¨ å—: å±•
ğŸ“¨ å—: æ¿
ğŸ“¨ å—: å†…å®¹åŒ…æ‹¬:
- 
ğŸ“¨ å—:  1ä»½PDF
ğŸ“¨ å—: æ–‡ä»¶: "4
ğŸ“¨ å—: .mendelian inheritance
ğŸ“¨ å—:  3 3
ğŸ“¨ å—: -15-
ğŸ“¨ å—: 24.pdf"
...
æ”¶åˆ°å—æ•°: 20
âœ… æµå¼å¤„ç†æ­£å¸¸å·¥ä½œ
```

## åŠŸèƒ½ç¡®è®¤

### âœ… å·²ä¿®å¤çš„åŠŸèƒ½
1. **ä¸“å®¶LLMæµå¼å¤„ç†**: ä¸å†æŠ¥é”™`'ExpertLLM' object has no attribute '_prepare_messages'`
2. **WebSocketæµå¼è¾“å‡º**: èƒ½å¤Ÿæ­£å¸¸æ¥æ”¶å’Œå¤„ç†æµå¼æ•°æ®å—
3. **å±•æ¿ä¸Šä¸‹æ–‡é›†æˆ**: ä¸“å®¶LLMèƒ½å¤Ÿæ­£ç¡®è·å–å¹¶åˆ©ç”¨å±•æ¿çš„å®æ—¶å†…å®¹
4. **æ™ºèƒ½ä¿¡æ¯æ£€ç´¢**: åŸºäºå®é™…å±•æ¿å†…å®¹å›ç­”é—®é¢˜

### âœ… ç³»ç»Ÿç‰¹æ€§
1. **å®æ—¶ä¸Šä¸‹æ–‡æ„ŸçŸ¥**: ä¸“å®¶LLMèƒ½å¤Ÿå‡†ç¡®è¯†åˆ«å±•æ¿ä¸Šçš„PDFæ–‡ä»¶å’Œç¬”è®°
2. **æµå¼å“åº”ä¼˜åŒ–**: ä½¿ç”¨requestsç›´æ¥å¤„ç†SSEæµï¼Œç¨³å®šæ€§æ›´é«˜
3. **é”™è¯¯å¤„ç†æœºåˆ¶**: å®Œå–„çš„å¼‚å¸¸æ•è·å’Œæ—¥å¿—è®°å½•
4. **ä¼šè¯å†å²ç®¡ç†**: æ­£ç¡®çš„æ¶ˆæ¯æ ¼å¼åŒ–å’Œå†å²è®°å½•ä¿æŒ

## ä½¿ç”¨æŒ‡å—

ç°åœ¨ç”¨æˆ·å¯ä»¥æ­£å¸¸ä½¿ç”¨ä»¥ä¸‹åŠŸèƒ½ï¼š

1. **å‰ç«¯WebSocketè¿æ¥**:
   ```javascript
   const ws = new WebSocket('ws://localhost:8000/api/expert/stream');
   ws.send(JSON.stringify({
       "query": "å‘Šè¯‰æˆ‘4å¼€å¤´é‚£ä¸ªPDFæ–‡ä»¶ç¬¬4é¡µçš„å†…å®¹",
       "board_id": "your-board-id",
       "history": []
   }));
   ```

2. **æ¥æ”¶æµå¼å“åº”**:
   ```javascript
   ws.onmessage = function(event) {
       const data = JSON.parse(event.data);
       if (data.chunk) {
           // å¤„ç†æµå¼æ•°æ®å—
           console.log("æ¥æ”¶åˆ°:", data.chunk);
       } else if (data.done) {
           // æµå¼å¤„ç†å®Œæˆ
           console.log("å®Œæˆ:", data.full_response);
       } else if (data.error) {
           // å¤„ç†é”™è¯¯
           console.error("é”™è¯¯:", data.error);
       }
   };
   ```

## æ€»ç»“

âœ… **é—®é¢˜å·²å®Œå…¨è§£å†³**: ä¸“å®¶LLMçš„WebSocketæµå¼å¤„ç†ç°åœ¨æ­£å¸¸å·¥ä½œ
âœ… **åŠŸèƒ½å®Œæ•´æ€§**: ä»å‰ç«¯åˆ°åç«¯çš„å®Œæ•´æ•°æ®æµå·²æ‰“é€š
âœ… **ä¸Šä¸‹æ–‡æ„ŸçŸ¥**: æ™ºèƒ½ä¿¡æ¯æ”¶é›†ç³»ç»Ÿèƒ½å¤Ÿæ­£ç¡®æ£€ç´¢å±•æ¿å†…å®¹
âœ… **æ€§èƒ½ä¼˜åŒ–**: æµå¼å¤„ç†å“åº”æ›´å¿«ã€æ›´ç¨³å®š

ç”¨æˆ·ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨ä¸“å®¶LLMçš„æ‰€æœ‰åŠŸèƒ½ï¼ŒåŒ…æ‹¬åŸºäºå±•æ¿å†…å®¹çš„æ™ºèƒ½é—®ç­”å’Œæµå¼å“åº”ã€‚ 

# ç”¨æˆ·åé¦ˆé—®é¢˜ä¿®å¤æ€»ç»“æŠ¥å‘Š

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆäº†ä¸¤ä¸ªå…³é”®é—®é¢˜ï¼š

### 1. æ”¹è¿›æ³¨é‡ŠåŠŸèƒ½å¤±è´¥
- é”™è¯¯ä¿¡æ¯ï¼š`_api__WEBPACK_IMPORTED_MODULE_16__.default.improveAnnotation is not a function`
- æ ¹æœ¬åŸå› ï¼šå‰ç«¯APIæ–‡ä»¶ä¸­ç¼ºå°‘`improveAnnotation`å‡½æ•°å®šä¹‰

### 2. å›¾åƒè¯†åˆ«ç»“æœæœªä¿å­˜
- é—®é¢˜æè¿°ï¼šä½¿ç”¨å›¾åƒè¯†åˆ«åŠŸèƒ½åï¼Œå¯¹åº”é¡µç çš„txtæ–‡ä»¶æ²¡æœ‰å˜åŒ–ï¼Œä»ç„¶æ˜¯PDFæå–çš„ç»“æœ
- ç”¨æˆ·æœŸæœ›ï¼šè¯†åˆ«åçš„ç»“æœåº”è¯¥å­˜å‚¨åœ¨txtæ–‡ä»¶é‡Œï¼Œæ›¿æ¢æ‰åŸæ¥çš„å†…å®¹

## ä¿®å¤æªæ–½

### âœ… ä¿®å¤1ï¼šæ·»åŠ improveAnnotation APIå‡½æ•°

**æ–‡ä»¶ï¼š** `frontend/src/api.js`

**ä¿®æ”¹å†…å®¹ï¼š**
```javascript
// æ”¹è¿›æ³¨é‡Š - æ–°å¢å‡½æ•°
improveAnnotation: (filename, pageNumber, currentAnnotation, improveRequest, sessionId = null, boardId = null) => {
  console.log(`APIè¯·æ±‚: æ”¹è¿›æ³¨é‡Š, æ–‡ä»¶: ${filename}, é¡µç : ${pageNumber}`);
  console.log(`æ”¹è¿›æç¤º: ${improveRequest || 'æ— '}`);
  
  const query = new URLSearchParams();
  if (sessionId) query.append('session_id', sessionId);
  
  const endpoint = `/materials/${filename}/pages/${pageNumber}/improve-annotation?${query.toString()}`;
  
  const body = {
    current_annotation: currentAnnotation,
    improve_request: improveRequest,
    board_id: boardId
  };
  
  console.log('æ”¹è¿›æ³¨é‡Šè¯·æ±‚ä½“:', JSON.stringify(body));
  
  return apiRequest(endpoint, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
}
```

**æ•ˆæœï¼š**
- âœ… è§£å†³äº†å‰ç«¯è°ƒç”¨`api.improveAnnotation`æ—¶çš„"function not found"é”™è¯¯
- âœ… æ”¯æŒä¼ é€’å½“å‰æ³¨é‡Šã€æ”¹è¿›è¯·æ±‚ã€ä¼šè¯IDå’Œå±•æ¿ID
- âœ… åŒ…å«è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºä¾¿äºè°ƒè¯•

### âœ… ä¿®å¤2ï¼šå›¾åƒè¯†åˆ«ç»“æœè‡ªåŠ¨ä¿å­˜åˆ°txtæ–‡ä»¶

**æ–‡ä»¶ï¼š** `controller.py`

**ä¿®æ”¹å†…å®¹ï¼š**
```python
# å¼ºåˆ¶è§†è§‰è¯†åˆ«çš„æƒ…å†µ
if force_vision:
    # è·å–å›¾ç‰‡è·¯å¾„
    img_path = get_page_image(filename, page_number)
    
    if not img_path:
        raise ValueError(f"æ— æ³•è·å–é¡µé¢å›¾ç‰‡: {filename} ç¬¬{page_number}é¡µ")
    
    # è°ƒç”¨è§†è§‰LLMï¼Œä¼ é€’ä¸Šä¸‹æ–‡å­—å…¸å’Œå±•æ¿ID
    vision_result = vision_llm_recognize(img_path, session_id=session_id, file_id=filename, 
                                       context=context_dict, board_id=board_id)
    
    # ğŸ”¥ æ–°å¢åŠŸèƒ½ï¼šå°†è§†è§‰è¯†åˆ«ç»“æœä¿å­˜åˆ°txtæ–‡ä»¶ä¸­ï¼Œæ›¿æ¢åŸå§‹PDFæå–çš„å†…å®¹
    try:
        page_file = os.path.join(PAGE_DIR, f"{filename}_page_{page_number}.txt")
        with open(page_file, 'w', encoding='utf-8') as f:
            f.write(vision_result)
        print(f"âœ… è§†è§‰è¯†åˆ«ç»“æœå·²ä¿å­˜åˆ°: {page_file}")
    except Exception as e:
        print(f"âš ï¸ ä¿å­˜è§†è§‰è¯†åˆ«ç»“æœå¤±è´¥: {str(e)}")
        # å³ä½¿ä¿å­˜å¤±è´¥ï¼Œä¹Ÿç»§ç»­è¿”å›ç»“æœ
    
    return {"source": "vision", "note": vision_result, "session_id": session_id}
```

**æ•ˆæœï¼š**
- âœ… è§†è§‰è¯†åˆ«åçš„å†…å®¹ä¼šè‡ªåŠ¨æ›¿æ¢å¯¹åº”é¡µç çš„txtæ–‡ä»¶å†…å®¹
- âœ… åç»­è°ƒç”¨`get_page_text`å°†è·å–è¯†åˆ«åçš„å†…å®¹ï¼Œè€Œä¸æ˜¯åŸå§‹PDFæå–çš„å†…å®¹
- âœ… å³ä½¿ä¿å­˜å¤±è´¥ä¹Ÿä¸ä¼šå½±å“è§†è§‰è¯†åˆ«åŠŸèƒ½
- âœ… åŒ…å«è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºä¾¿äºè°ƒè¯•

## æŠ€æœ¯ç»†èŠ‚

### APIå‡½æ•°å‚æ•°è¯´æ˜
```javascript
improveAnnotation(filename, pageNumber, currentAnnotation, improveRequest, sessionId, boardId)
```
- `filename`: PDFæ–‡ä»¶å
- `pageNumber`: é¡µç 
- `currentAnnotation`: å½“å‰æ³¨é‡Šå†…å®¹
- `improveRequest`: ç”¨æˆ·çš„æ”¹è¿›è¦æ±‚
- `sessionId`: ä¼šè¯IDï¼ˆå¯é€‰ï¼‰
- `boardId`: å±•æ¿IDï¼ˆå¯é€‰ï¼‰

### æ–‡ä»¶ä¿å­˜é€»è¾‘
1. è§†è§‰è¯†åˆ«å®Œæˆåï¼Œç«‹å³å°†ç»“æœå†™å…¥å¯¹åº”çš„txtæ–‡ä»¶
2. æ–‡ä»¶è·¯å¾„æ ¼å¼ï¼š`pages/{filename}_page_{page_number}.txt`
3. ä½¿ç”¨UTF-8ç¼–ç ç¡®ä¿ä¸­æ–‡å†…å®¹æ­£ç¡®ä¿å­˜
4. é”™è¯¯å¤„ç†ç¡®ä¿å³ä½¿ä¿å­˜å¤±è´¥ä¹Ÿä¸å½±å“ä¸»è¦åŠŸèƒ½

## éªŒè¯ç»“æœ

### âœ… ä»£ç éªŒè¯
- å‰ç«¯APIå‡½æ•°ï¼šå·²æ·»åŠ å¹¶éªŒè¯è¯­æ³•æ­£ç¡®
- åç«¯ä¿å­˜é€»è¾‘ï¼šå·²æ·»åŠ å¹¶éªŒè¯ä»£ç ç»“æ„æ­£ç¡®
- æ–‡ä»¶å†™å…¥é€»è¾‘ï¼šå·²éªŒè¯ä»£ç é€»è¾‘å®Œæ•´

### ğŸš€ ä½¿ç”¨æµ‹è¯•å»ºè®®
1. **æµ‹è¯•æ”¹è¿›æ³¨é‡ŠåŠŸèƒ½ï¼š**
   - åœ¨ä»»æ„PDFé¡µé¢ç‚¹å‡»"æ”¹è¿›æ³¨é‡Š"
   - åº”è¯¥ä¸å†å‡ºç°"function not found"é”™è¯¯
   
2. **æµ‹è¯•å›¾åƒè¯†åˆ«ä¿å­˜åŠŸèƒ½ï¼š**
   - å¯¹ä»»æ„PDFé¡µé¢ä½¿ç”¨"å›¾åƒè¯†åˆ«"åŠŸèƒ½
   - æ£€æŸ¥`pages/`ç›®å½•ä¸‹å¯¹åº”çš„txtæ–‡ä»¶
   - æ–‡ä»¶å†…å®¹åº”è¯¥æ˜¯è¯†åˆ«åçš„ç»“æœï¼Œè€Œä¸æ˜¯åŸå§‹PDFæå–çš„æ–‡æœ¬

## æ³¨æ„äº‹é¡¹

### âš ï¸ æœåŠ¡å™¨é‡å¯
ä¿®æ”¹ç”Ÿæ•ˆéœ€è¦é‡å¯æœåŠ¡å™¨ï¼š
```bash
# åœæ­¢å½“å‰æœåŠ¡å™¨ï¼ˆCtrl+Cï¼‰
# é‡æ–°å¯åŠ¨
python main.py
```

### ğŸ’¡ åç»­ä¼˜åŒ–å»ºè®®
1. **ç‰ˆæœ¬æ§åˆ¶**ï¼šå¯è€ƒè™‘ä¿ç•™åŸå§‹PDFæå–çš„å†…å®¹ä½œä¸ºå¤‡ä»½
2. **ç”¨æˆ·åé¦ˆ**ï¼šæ·»åŠ è§†è§‰è¯†åˆ«ä¿å­˜æˆåŠŸçš„å‰ç«¯æç¤º
3. **é”™è¯¯å¤„ç†**ï¼šå¢å¼ºæ–‡ä»¶å†™å…¥å¤±è´¥æ—¶çš„ç”¨æˆ·æç¤º

## ä¿®å¤çŠ¶æ€

| é—®é¢˜ | çŠ¶æ€ | éªŒè¯æ–¹å¼ |
|------|------|----------|
| improveAnnotationå‡½æ•°ç¼ºå¤± | âœ… å·²ä¿®å¤ | ä»£ç å·²æ·»åŠ åˆ°api.js |
| å›¾åƒè¯†åˆ«ç»“æœæœªä¿å­˜ | âœ… å·²ä¿®å¤ | ä»£ç å·²æ·»åŠ åˆ°controller.py |
| æœåŠ¡å™¨é‡å¯è¦æ±‚ | âš ï¸ å¾…æ“ä½œ | éœ€è¦ç”¨æˆ·é‡å¯æœåŠ¡å™¨ |

---

**ä¿®å¤å®Œæˆæ—¶é—´ï¼š** 2025-05-24  
**ä¿®å¤äººå‘˜ï¼š** AI Assistant  
**çŠ¶æ€ï¼š** å®Œæˆï¼Œå¾…æµ‹è¯•éªŒè¯ 